{% extends "base.html" %}
{% block head %}
    <link href='/static/fullcalendar/core/main.css' rel='stylesheet'/>
    <link href='/static/fullcalendar/daygrid/main.css' rel='stylesheet' />
    <link href='/static/fullcalendar/timegrid/main.css' rel='stylesheet' />
    <link href='/static/fullcalendar/list/main.css' rel='stylesheet' />
    <link href='/static/clockpicker/bootstrap-clockpicker.min.css' rel='stylesheet' />

    <style>
        :root {
            --sched-1-color: #59981a;
            --sched-2-color: #1e3148;
            --sched-3-color: #e43d40;
        }
        #calendar {
            width: 100%;
            height: 100%;
        }
        .dropdown-max-size{
            max-height: 200px;
            overflow-y:auto;
        }
        .fc-today { background: #e2e2e2 !important; }
        .dropdown:hover>.dropdown-menu-on-hover {
            display: block;
        }
        .tooltip-inner {
            white-space: pre;
            max-width: none;
            background-color: #ffb019;
            border-color: #ffb019;
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
            color: black;
        }
        .fc-event.fc-draggable {
            cursor: move;
        }
    </style>
{% endblock %}


{% block bodyhead %}
    <div>
        <nav class="navbar navbar-expand" style="padding: 0;">
            <ul class="navbar-nav mr-auto">
                <ul class="nav nav-tabs" id="nav-tab-cal">
                    <li class="nav-item" style="cursor: pointer;">
                        <a class="nav-link active" id="nav-brut" data-toggle="tab" aria-expanded="false">{{ _('ADE schedule') }}</a>
                    </li>
                    {% if data_sched|length > 0 %}
                        <li class="nav-item" style="cursor: pointer;">
                            <a class="nav-link" id="nav-sched-1" data-toggle="tab" aria-expanded="false">{{ _('1st schedule') }}</a>
                        </li>
                    {% else %}
                        <li class="nav-item" style="cursor: not-allowed">
                            <a class="nav-link disabled">{{ _('1st schedule') }}</a>
                        </li>
                    {% endif %}
                    {% if data_sched|length > 1 %}
                        <li class="nav-item" style="cursor: pointer;">
                            <a class="nav-link" id="nav-sched-2" data-toggle="tab" aria-expanded="false">{{ _('2nd schedule') }}</a>
                        </li>
                    {% else %}
                        <li class="nav-item" style="cursor: not-allowed">
                            <a class="nav-link disabled">{{ _('2nd schedule') }}</a>
                        </li>
                    {% endif %}
                    {% if data_sched|length > 2 %}
                        <li class="nav-item" style="cursor: pointer;">
                            <a class="nav-link" id="nav-sched-3" data-toggle="tab" aria-expanded="false">{{ _('3rd schedule') }}</a>
                        </li>
                    {% else %}
                        <li class="nav-item" style="cursor: not-allowed">
                            <a class="nav-link disabled">{{ _('3rd schedule') }}</a>
                        </li>
                    {% endif %}
                    {% if data_sched|length > 0 %}
                        <li class="nav-item dropdown" id="dropdown-compare">
                            <a class="nav-link dropdown-toggle" data-toggle="dropdown" role="button">{{ _('Compare') }}</a>
                            <div class="dropdown-menu dropdown-menu-on-hover" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 39px, 0px); top: 0px; left: 0px; will-change: transform;">
                                <div class="form-group">
                                    <a class="dropdown-item">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="check-sched-default">
                                            <label class="custom-control-label" for="check-sched-default">{{ _('ADE Schedule') }}</label>
                                        </div>
                                    </a>
                                    <a class="dropdown-item">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="check-sched-1">
                                            <label class="custom-control-label" for="check-sched-1">{{ _('1st schedule') }}</label>
                                        </div>
                                    </a>
                                    {% if data_sched|length > 1 %}
                                        <a class="dropdown-item">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="check-sched-2">
                                                <label class="custom-control-label" for="check-sched-2">{{ _('2nd schedule') }}</label>
                                            </div>
                                        </a>
                                    {% endif %}
                                    {% if data_sched|length > 2 %}
                                        <a class="dropdown-item">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="check-sched-3">
                                                <label class="custom-control-label" for="check-sched-3">{{ _('3rd schedule') }}</label>
                                            </div>
                                        </a>
                                    {% endif %}

                                </div>
                                <a class="dropdown-item" id="btn-sched-compare" style="cursor: pointer">Go !</a>
                            </div>
                        </li>
                    {% else %}
                        <li class="nav-item dropdown" style="cursor: not-allowed">
                            <a class="nav-link disabled">{{ _('Compare') }}</a>
                        </li>
                    {% endif %}
                </ul>
            </ul>
            <ul class="navbar-nav">
                <div>
                    <div class="btn-group" role="group">
                        {% if up_to_date == False %}
                            <button class="btn btn-danger" type="button" style="width: 100%;" id="btn-compute" onclick=computeButton();><strong>{{ _('Compute') }}</strong></button>
                        {% else %}
                            <button class="btn btn-success" type="button" style="width: 100%;" id="btn-compute" onclick=computeButton()><strong>{{ _('Compute') }}</strong></button>
                        {% endif %}
                        <button class="btn btn-secondary" type="button" onclick=refreshButton(); style="width: 100%;"><strong>{{ _('Refresh') }}</strong></button>
                        <button class="btn btn-warning" type="button" style="width: 100%;" onclick=clearButton();><strong>{{ _('Clear') }}</strong></button>
                    </div>
                </div>
            </ul>
        </nav>
    </div>
{% endblock %}

{% block body %}
    <!-- TIME PROMPT (modal) -->
    <div class="modal fade" id="time-prompt" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Forbidden Time Slot') }}</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col">
                            <label for="start_time"><strong>{{ _('Start') }}</strong></label>
                            <div class="input-group mb-3 clockpicker" data-placement="left">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                </div>
                                <input type="time" class="form-control" value="08:00" id="start_time" maxlength="5">
                            </div>
                        </div>
                        <div class="col">
                            <label for="end_time" style="justify-content: flex-end;"><strong>{{ _('End') }}</strong></label>
                            <div class="input-group mb-3 clockpicker" data-placement="right">
                                <input type="time" class="form-control" value="10:00" id="end_time" maxlength="5">
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal" style="float: left;">{{ _('Cancel') }}</button>
                    <button type="button" class="btn btn-success" id="time-prompt-confirm" style="float: right;">{{ _('Confirm') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EXPORT PROMPT (modal) -->
    <div class="modal fade" id="exportPrompt" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Export Schedule') }}</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-3">
                            <select class="custom-select mr-sm-2" id="select-sched-download">
                                <option value="" selected disabled hidden>{{ _('Choose...') }}</option>
                                <option value="0">{{ _('ADE Schedule') }}</option>
                                <option value="1">{{ _('1st schedule') }}</option>
                                <option value="2">{{ _('2nd schedule') }}</option>
                                <option value="3">{{ _('3rd schedule') }}</option>
                            </select>
                            <small class="form-text text-muted">{{ _('Select your schedule.') }}</small>
                        </div>
                        <div class="col-xl-9 ml-auto">
                            <div class="float-right" style="width: 100%">
                                <div class="input-group" style="width: 100%;">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-secondary" id="btn-copy-link" type="button" onclick=copyButton('input-generate-link'); data-toggle="tooltip" data-placement="bottom" title="{{ _('Copy link') }}">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <input class="form-control" id="input-generate-link" type="text" placeholder="{{ _('ex: ade-scheduler.info.ucl.ac.be/getcalendar/your_link') }}" readonly>
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" id="btn-link-generate" type="button" onclick="generateButton();">{{ _('Generate link') }}</button>
                                    </div>
                                </div>
                                <small class="form-text text-muted" style="float: right">{{ _('Generate a subscription link') }}</small>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-content: flex-end;">
                        <div style="margin-top: 20px">
                            <form class="collapse show" id="form-link-login">
                                <div class="form-group row">
                                    <label class="col col-form-label-sm" for="input-link-login"><b>{{ _('Login') }}</b></label>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="input-link-login" style="width: 200px;" placeholder={{ _('Login') }}>
                                        <div class="invalid-feedback" id="input-link-login-feedback" style="max-width: 195px; word-break: break-word;">
                                            {{ _('Please specify a login') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col col-form-label-sm" for="input-link-password"><b>{{ _('Password') }}</b></label>
                                    <div class="col-auto">
                                        <input type="password" class="form-control" id="input-link-password" style="max-width: 200px;" placeholder={{ _('Password') }}>
                                        <div class="invalid-feedback">
                                            {{ _('Please choose a password') }}
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="switch-password" data-toggle="collapse" data-target="#form-link-login" checked>
                                <label class="custom-control-label" for="switch-password">{{ _('Modifiable & protected link') }}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="alert alert-danger mr-auto hide" id="download-alert1" style="width: 50%; float: left; margin-bottom: 0">
                        <button type="button" class="close" onclick="alertButton('download-alert1');">&times;</button>
                        {{ _('Your schedules are not updated ! Please compute first.') }}
                    </div>
                    <div class="alert alert-danger mr-auto hide" id="download-alert2" style="width: 50%; float: left; margin-bottom: 0">
                        <button type="button" class="close" onclick="alertButton('download-alert2');">&times;</button>
                        {{ _('Please specify a schedule first.') }}
                    </div>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">{{ _('Close') }}</button>
                    <button type="button" class="btn btn-success" onclick=downloadButton();>{{ _('Download file') }}</button>
                    <button class="btn btn-primary" id="btn-create-acc" type="button" onclick="generateButton();">{{ _('Create account') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN PROMPT (modal) -->
    <div class="modal fade" id="loginPrompt" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Get/Modify Schedule') }}</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; justify-content: space-between; align-content: flex-end;">
                        <div>
                            <form id="form-link-login">
                                <div class="form-group row">
                                    <label class="col col-form-label-sm" for="input-load-login"><b>{{ _('Login') }}</b></label>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="input-load-login" style="width: 200px;" placeholder={{ _('Login') }}>
                                        <div class="invalid-feedback" id="load-login-feedback">
                                            {{ _('Login is required !') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row" style="margin-bottom: 0;">
                                    <label class="col col-form-label-sm" for="input-load-password"><b>{{ _('Password') }}</b></label>
                                    <div class="col-auto">
                                        <input type="password" class="form-control" id="input-load-password" style="width: 200px;" placeholder={{ _('Password') }}>
                                        <div class="invalid-feedback" id="load-pwd-feedback">
                                            {{ _('Password is required !') }}
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div>
                            <div>
                                <select class="custom-select" id="select-sched-save">
                                    <option value="no-change" selected>{{ _('Don\'t change') }}</option>
                                    <option value="0">{{ _('ADE Schedule') }}</option>
                                    <option value="1">{{ _('1st schedule') }}</option>
                                    <option value="2">{{ _('2nd schedule') }}</option>
                                    <option value="3">{{ _('3rd schedule') }}</option>
                                </select>
                                <small class="form-text text-muted">{{ _('Update your schedule choice.') }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">{{ _('Close') }}</button>
                    <div>
                        <button type="button" class="btn btn-outline-dark" onclick=forgotButton();>{{ _('Forgot link ?') }}</button>
                        <button type="button" class="btn btn-primary" onclick=loadButton();>{{ _('Load session') }}</button>
                        <button type="button" class="btn btn-primary" onclick=saveButton();>{{ _('Save changes') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FORGOT LINK (modal) -->
    <div class="modal modal-info fade in" id="modal-forgot-link" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Your Link') }}</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="input-group" style="width: 100%;">
                        <input class="form-control" id="input-copy-link" type="text" placeholder="{{ _('ex: adescheduler.com/getcalendar?=subscription_link') }}" readonly>
                        <div class="input-group-append">
                            <button class="btn btn-primary" id="btn-link-copy" type="button" onclick=copyButton('input-copy-link');>{{ _('Copy link') }}</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">{{ _('Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NO COMPARAISON SPECIFIED (modal) -->
    <div class="modal modal-warning fade in" id="modal-no-comp" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('WARNING') }}</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <div class="modal-body">
                <p>{{ _('Please select at least a schedule to compare !') }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">{{ _('Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- WRONG FORMAT (modal) -->
    <div class="modal modal-danger fade in" id="modal-wrong-format" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('ERROR') }}</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <div class="modal-body">
                <p>{{ _('You specified a wrong time format ! Please try again.') }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-light" data-dismiss="modal">{{ _('Close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-right: 15px; flex-basis: 160px; min-width: 160px;">
        <!-- drag-n-drop body -->
        <div class="card border-primary mb-3">
            <div class="card-header" style="padding: 5%; text-align: center;"><strong>{{ _('Block Time Slots') }}</strong></div>
            <div class="card-body" style="padding: 5% 10%;">
                <div id='external-events-list'>
                    <span class="badge badge-success" style="width: 100%; height: 100%; cursor: move;">{{ _('Low') }}</span>
                    <span class="badge badge-warning" style="width: 100%; height: 100%; cursor: move;">{{ _('Medium') }}</span>
                    <span class="badge badge-danger" style="width: 100%; height: 100%; cursor: move;">{{ _('High') }}</span>
                </div>
            </div>
        </div>

        <!-- course body -->
        <div class="card border-primary mb-3" id="course-body">
            <div class="card-header" style="padding: 5%; text-align: center;"><strong>{{ _('Current Courses') }}</strong></div>
            <div class="card-body" style="padding: 5%">
                <table style="border-collapse: collapse">
                    <tbody>
                        <!-- For the course-->
                        {% if codes|length < 1  %}
                            <tr style="align: center">
                                <td style="vertical-align: middle; padding-bottom:10px">
                                    {{ _('None') }}
                                </td>
                            </tr>
                        {% endif %}
                        {% for code in codes %}
                            <tr style="align: center; padding: 0;">
                                <td style="word-break: break-all; padding: 0;">
                                    <div class="dropdown dropright" style="margin: 0; padding: 0; overflow-wrap: break-word;">
                                        <div class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" style="margin-right: -.125rem; margin-left: 0; padding: 0; overflow: hidden; width: 110px">
                                             {{ code }}
                                        </div>
                                        <div class="dropdown-menu dropdown-menu-on-hover dropdown-menu-right dropdown-max-size" x-placement="bottom-start">
                                            {% if id[code]|length == 0 %}
                                                <label class="custom-control-label" style="margin-left: 5px"><strong>{{ _('No event found !') }}</strong></label>
                                            {% else %}
                                                <!-- ID OF CMs -->
                                                {% if id[code].CM|length > 0 %}
                                                    <div class="custom-control custom-checkbox" style="margin-left: 3px">
                                                        <input type="checkbox" class="custom-control-input" id="CM-{{ code }}-all" checked>
                                                        <label class="custom-control-label" for="CM-{{ code }}-all"><strong>CM:</strong></label>
                                                    </div>
                                                    <div id="CM-{{ code }}" onclick=areCheckboxesChecked(this.id);>
                                                        {% for cm_id in id[code].CM %}
                                                            <a class="dropdown-item">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input" id="CM:{{ cm_id }}" checked>
                                                                    <label class="custom-control-label" for="CM:{{ cm_id }}">{{ cm_id }}</label>
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}

                                                <!-- ID OF TPs -->
                                                {% if id[code].TP|length > 0 %}
                                                    <div class="custom-control custom-checkbox" style="margin-left: 3px">
                                                        <input type="checkbox" class="custom-control-input" id="TP-{{ code }}-all" checked>
                                                        <label class="custom-control-label" for="TP-{{ code }}-all"><strong>TP:</strong></label>
                                                    </div>
                                                    <div id="TP-{{ code }}" onclick=areCheckboxesChecked(this.id);>
                                                        {% for tp_id in id[code].TP %}
                                                            <a class="dropdown-item">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input" id="TP:{{ tp_id }}" checked>
                                                                    <label class="custom-control-label" for="TP:{{ tp_id }}">{{ tp_id }}</label>
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}

                                                <!-- ID OF Exams -->
                                                {% if id[code].EXAM|length > 0 %}
                                                    <div class="custom-control custom-checkbox" style="margin-left: 3px">
                                                        <input type="checkbox" class="custom-control-input" id="EXAM-{{ code }}-all" checked>
                                                        <label class="custom-control-label" for="EXAM-{{ code }}-all"><strong>Exam:</strong></label>
                                                    </div>
                                                    <div id="EXAM-{{ code }}" onclick=areCheckboxesChecked(this.id);>
                                                        {% for exam_id in id[code].EXAM %}
                                                            <a class="dropdown-item">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input" id="EXAM:{{ exam_id }}" checked>
                                                                    <label class="custom-control-label" for="EXAM:{{ exam_id }}">{{ exam_id }}</label>
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}

                                                <!-- ID OF Orals -->
                                                {% if id[code].ORAL|length > 0 %}
                                                    <div class="custom-control custom-checkbox" style="margin-left: 3px">
                                                        <input type="checkbox" class="custom-control-input" id="ORAL-{{ code }}-all" checked>
                                                        <label class="custom-control-label" for="ORAL-{{ code }}-all"><strong>Oral:</strong></label>
                                                    </div>
                                                    <div id="ORAL-{{ code }}" onclick=areCheckboxesChecked(this.id);>
                                                        {% for oral_id in id[code].ORAL %}
                                                            <a class="dropdown-item">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input" id="ORAL:{{ oral_id }}" checked>
                                                                    <label class="custom-control-label" for="ORAL:{{ oral_id }}">{{ oral_id }}</label>
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}

                                                <!-- ID OF Others -->
                                                {% if id[code].Other|length > 0 %}
                                                    <div class="custom-control custom-checkbox" style="margin-left: 3px">
                                                        <input type="checkbox" class="custom-control-input" id="Other-{{ code }}-all" checked>
                                                        <label class="custom-control-label" for="Other-{{ code }}-all"><strong>Other:</strong></label>
                                                    </div>
                                                    <div id="Other-{{ code }}" onclick=areCheckboxesChecked(this.id);>
                                                        {% for other_id in id[code].Other %}
                                                            <a class="dropdown-item">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input" id="Other:{{ other_id }}" checked>
                                                                    <label class="custom-control-label" for="Other:{{ other_id }}">{{ other_id }}</label>
                                                                </div>
                                                            </a>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td style="padding: 0">
                                    <form method="post" action="/remove/code/{{ code }}">
                                        <button class="btn btn-default" type="submit" style="background-color: transparent; border-color: transparent;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add a course code -->
        <div class="form-group" style="margin-bottom: -5px">
            <form class="form-horizontal" action="/" method="post">
                <label class="control-label"><strong>{{ _('Add a course') }}</strong></label>
                <div class="input-group mb-3">
                    <input type="text" id='course-input' class="form-control" name="course_code" placeholder="Code">
                    <div class="input-group-append">
                        <button class="btn btn-secondary" type="submit" name="submit" value="Add"><strong>+</strong></button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Import/Export button group -->
        <div class="btn-group" style="width: 100%;">
            <button class="btn btn-secondary" data-toggle="modal" data-target="#exportPrompt" style="padding-left: 5px; padding-right: 5px;">{{ _('Export') }}</button>
            <button class="btn btn-secondary" data-toggle="modal" data-target="#loginPrompt" style="padding-left: 5px; padding-right: 5px;">{{ _('Log in') }}</button>
        </div>
    </div>

    <!-- calendar body -->
    <div style="flex-direction: column">
        <div class="card border-primary mb-3" style="flex-grow: 1">
            <div class="card-body">
                <div id='calendar'></div>
            </div>
        </div>
        <div class="text-danger">{{ _('Disclaimer: this software is not an official UCLouvain tool. It has been designed with the purpose to help the EPL students with scheduling. This tool is based on ADE but does not replace standard scheduling rules, nor the instructions given by university officials and teachers as those may vary from one course to another.') }}</div>
    </div>
{% endblock %}


{% block js %}
    <script src='/static/fullcalendar/core/main.js'></script>
    <script src='/static/fullcalendar/interaction/main.js'></script>
    <script src='/static/fullcalendar/daygrid/main.js'></script>
    <script src='/static/fullcalendar/list/main.js'></script>
    <script src='/static/fullcalendar/timegrid/main.js'></script>
    <script src='/static/fullcalendar/bootstrap/main.js'></script>
    <script src='/static/fullcalendar/core/locales/fr.js'></script>
    <script src='/static/clockpicker/bootstrap-clockpicker.min.js'></script>
    <script src='/static/bootbox/bootbox.min.js'></script>
    <script src='/static/bootbox/bootbox.locales.min.js'></script>
    <script src='/static/js/colorgradient.js'></script>

    <script>
        // On load: focus on course-input + repopulate checkboxes
        window.onload = function() {
            document.getElementById("course-input").focus();
            repopulateCheckbox()
        };
    </script>

    <script>
        var base_url = 'https://ade-scheduler.info.ucl.ac.be';

        $('#switch-password').change(function () {
            $('#btn-create-acc').toggle(this.checked);
        });

        function loadButton() {
            if (!$('#input-load-login').val() || !$('#input-load-password').val()) {
                if (!$('#input-load-login').val()) {
                    $('#input-load-login').addClass('is-invalid');
                }
                if (!$('#input-load-password').val()) {
                    $('#input-load-password').addClass('is-invalid');
                }
            } else {
                let login = $('#input-load-login').val();
                let pwd = $('#input-load-password').val();
                $.ajax({
                    url: '/getsettings',
                    type: 'POST',
                    data: {'login': login, 'password': pwd, 'reqType': 'load'},
                    success: function (data) {
                        localStorage.setItem('checkboxValues', data);
                        $('#loginPrompt').modal('hide');
                        location = location;
                    },
                    error: function (data) {
                        $('#load-login-feedback').text(data.responseText);
                        $('#load-pwd-feedback').text(data.responseText);
                        $('#input-load-password').addClass('is-invalid');
                        $('#input-load-login').addClass('is-invalid');
                    },
                });
            }
        }

        function saveButton() {
            if (!$('#input-load-login').val() || !$('#input-load-password').val()) {
                if (!$('#input-load-login').val()) {
                    $('#input-load-login').addClass('is-invalid');
                }
                if (!$('#input-load-password').val()) {
                    $('#input-load-password').addClass('is-invalid');
                }
            } else {
                let login = $('#input-load-login').val();
                let pwd = $('#input-load-password').val();
                let choice = $('#select-sched-save :selected').val();
                let checkState = localStorage.getItem('checkboxValues');
                $.ajax({
                    url: '/getsettings',
                    type: 'POST',
                    data: {'login': login, 'password': pwd, 'reqType': 'save', 'choice': choice, 'check': checkState},
                    success: function (data) {
                        $('#input-load-login').removeClass('is-invalid');
                        $('#input-load-password').removeClass('is-invalid');
                        $('#input-load-login').addClass('is-valid');
                        $('#input-load-password').addClass('is-valid');
                        $('#loginPrompt').modal('hide');
                    },
                    error: function (data) {
                        $('#load-login-feedback').text(data.responseText);
                        $('#load-pwd-feedback').text(data.responseText);
                        $('#input-load-password').addClass('is-invalid');
                        $('#input-load-login').addClass('is-invalid');
                    },
                });
            }
        }

        function forgotButton() {
            if (!$('#input-load-login').val() || !$('#input-load-password').val()) {
                if (!$('#input-load-login').val()) {
                    $('#input-load-login').addClass('is-invalid');
                }
                if (!$('#input-load-password').val()) {
                    $('#input-load-password').addClass('is-invalid');
                }
            } else {
                let login = $('#input-load-login').val();
                let pwd = $('#input-load-password').val();
                $.ajax({
                    url: '/getsettings',
                    type: 'POST',
                    data: {'login': login, 'password': pwd, 'reqType': 'forgot'},
                    success: function (data) {
                        $('#input-load-login').removeClass('is-invalid');
                        $('#input-load-password').removeClass('is-invalid');
                        $('#input-load-login').addClass('is-valid');
                        $('#input-load-password').addClass('is-valid');
                        $('#loginPrompt').modal('hide');
                        $('#input-copy-link').val(base_url + '/getcalendar/' + data);
                        $('#modal-forgot-link').modal('show');
                    },
                    error: function (data) {
                        $('#load-login-feedback').text(data.responseText);
                        $('#load-pwd-feedback').text(data.responseText);
                        $('#input-load-password').addClass('is-invalid');
                        $('#input-load-login').addClass('is-invalid');
                    },
                    dataType: 'text'
                });
            }
        }

        function generateButton() {
            let choice = $('#select-sched-download :selected').val();
            if (!choice) {                                              // No schedule selected
                $('#download-alert1').addClass('hide');
                $('#download-alert2').removeClass('hide');
            } else if (!{{ up_to_date|tojson }} && choice !== '0') {    // Computation not up-to-date
                $('#download-alert2').addClass('hide');
                $('#download-alert1').removeClass('hide');
            } else {
                $('#download-alert2').addClass('hide');
                $('#download-alert1').addClass('hide');

                if ($('#switch-password').prop('checked')) {
                    // User has requested a "protected & modifiable link
                    if (!$('#input-link-login').val() || !$('#input-link-password').val()) {
                        if (!$('#input-link-login').val()) {
                            $('#input-link-login').addClass('is-invalid');
                        }
                        if (!$('#input-link-password').val()) {
                            $('#input-link-password').addClass('is-invalid');
                        }
                    } else {
                        let login = $('#input-link-login').val();
                        let pwd = $('#input-link-password').val();
                        let checkState = localStorage.getItem('checkboxValues');
                        $.ajax({
                            url: '/getcalendar/secure_link',
                            type: 'POST',
                            data: {'login': login, 'password': pwd, 'param': $('#select-sched-download :selected').val(), 'check': checkState},
                            success: function (data) {
                                $('#input-link-login').removeClass('is-invalid');
                                $('#input-link-login').addClass('is-valid');
                                $('#input-link-password').removeClass('is-invalid');
                                $('#input-link-password').addClass('is-valid');
                                $('#input-generate-link').val(base_url + '/getcalendar/' + data);
                                $('#input-generate-link').addClass('is-valid');
                                {#$('#btn-link-generate').prop('disabled', true);#}
                                $('#input-link-login-feedback').text({{ _('Please specify a login')|tojson }});
                            },
                            error: function (data) {
                                $('#input-link-login').addClass('is-invalid');
                                $('#input-link-password').removeClass('is-invalid');
                                $('#input-link-login-feedback').text(data.responseText);
                            },
                            dataType: 'text'
                        });
                    }
                } else {
                    // User has requested a random link without login
                    let link = '/getcalendar/' + new Date().getTime();
                    let linkLength = 50;
                    let charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                    let values = window.crypto.getRandomValues(new Uint32Array(linkLength));
                    for (let i=0; i < linkLength; i++) {
                        link += charset.charAt(values[i] % charset.length);
                    }
                    $.ajax({
                        url: link,
                        type: 'POST',
                        data:  {'param': $('#select-sched-download :selected').val()},
                        success: function(data) {
                             $('#input-generate-link').val(base_url + '/getcalendar/' + data);
                             $('#input-generate-link').addClass('is-valid');
                             {#$('#btn-link-generate').prop('disabled', true);#}
                        },
                        dataType: 'text'
                    });
                }
            }
        }

        function copyButton(id) {
            try {
                let toCopy = $('#' + id);
                toCopy.select();
                document.execCommand('copy');
            } catch(err) { }
        }

        function downloadButton() {
            let choice = $('#select-sched-download :selected').val();
            if (!choice) {
                $('#download-alert1').addClass('hide');
                $('#download-alert2').removeClass('hide');
            } else if (!{{ up_to_date|tojson }} && choice !== '0') {
                $('#download-alert2').addClass('hide');
                $('#download-alert1').removeClass('hide');
            } else {
                $('#download-alert2').addClass('hide');
                $('#download-alert1').addClass('hide');
                $("<form method='POST' action='/download/schedule/" + choice + "'></form>").appendTo("body").submit();
            }
        }

        function alertButton(id) {
            $('#' + id).addClass('hide');
        }

        function clearButton() {
            localStorage.removeItem('checkboxValues');
            $.post("/clear", {}, () => location = location)
        }

        function computeButton() {
            let data = refreshFunction();
            $.post("/compute", {'IDs': data}, () => location = location)
        }

        function refreshButton() {
            let data = refreshFunction();
            $.post("/get/id", {'IDs': data}, () => location = location);
        }

        // Fetches the current selected IDs
        function refreshFunction() {
            let selected_ids = [];
            {{ codes|safe }}.forEach(function (code) {
                Object.entries({{ id|safe }}[code]).forEach(function (entry) {
                    Object.values(entry[1]).forEach(function (value) {
                        if (document.getElementById(entry[0] + ':' + value).checked)
                            selected_ids.push(entry[0] + ':' + value);
                    });
                });
            });
            return JSON.stringify(selected_ids);
        }
    </script>

    <script>
        // Save checkbox state on check
        $('#course-body input[type="checkbox"]').change(function() {
            // small delay so every checkbox has time to 'react'
            setTimeout(function() {
                saveCheckbox();
            }, 1);
        });

        // Save checkbox state
        function saveCheckbox() {
            setTimeout(function() {
                let checkboxValues = {};
                $("#course-body :checkbox").each(function(){
                  checkboxValues[this.id] = this.checked;
                });
                localStorage.setItem('checkboxValues', JSON.stringify(checkboxValues));
            }, 5);
        }

        // Repopulate checkbox
        function repopulateCheckbox() {
            let checkboxValues = JSON.parse(localStorage.getItem('checkboxValues'));
            if (checkboxValues) {
                Object.keys(checkboxValues).forEach(function (element) {
                    let checked = checkboxValues[element];
                    let htmlElement = document.getElementById(element);
                    if (htmlElement)
                        htmlElement.checked = checked;
                });
            }
        }

        // Group checkboxes
        {{ codes|safe }}.forEach(function (code) {
            Object.keys({{ id|safe }}[code]).forEach(function (key) {
                $('#' + key + '-' + code + '-all').change(function() {
                    let all_checkboxes = $('#' + key + '-' + code + ' input[type="checkbox"]');
                    for (let j=0; j < all_checkboxes.length; j++) {
                        all_checkboxes[j].checked = this.checked;
                    }
                });
            });
        });

        // Toggle group checkbox
        function areCheckboxesChecked(id) {
            let all_checkboxes = $('#'+ id + ' input[type="checkbox"]');
            if (all_checkboxes.length === all_checkboxes.filter(":checked").length)
                $('#' + id + '-all').prop("checked", true);
            else
                $('#' + id + '-all').prop("checked", false);
        }
    </script>

    <script>
        // Course Events
        let schedules = {{ data_sched|safe }};
        let eventsArray = {{ data_base|safe }};
        let compIsRequested = false;

        // Forbidden time slots (user's input)
        let forbiddenTimeSlots = {{ fts|safe }};
        let dragToCopy = false;
        function send_fts_to_serv() {
            $.post('/get/fts', {'fts': JSON.stringify(forbiddenTimeSlots)});
            if ($('#btn-compute').hasClass('btn-success')) {
                $('#btn-compute').removeClass('btn-success');
                $('#btn-compute').addClass('btn-danger');
            }
        }

        // FullCalendar initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialise the draggable "forbidden time slots"
            let containerEl = document.getElementById('external-events-list');
            new FullCalendarInteraction.Draggable(containerEl, {
                itemSelector: '.badge'
            });

            // Initialize the calendar
            let calendarEl = document.getElementById('calendar');
            let calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: ['interaction', 'dayGrid', 'list', 'timeGrid', 'bootstrap'],
                themeSystem: 'bootstrap',
                height: 'auto',
                width: 'parent',
                header: {
                    left: 'prev,next, today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                minTime: '08:00:00',
                maxTime: '21:00:00',
                navLinks: true, // can click day/week names to navigate views
                editable: true,
                droppable: true,
                eventLimit: false, // allow "more" link when too many events
                weekNumberCalculation: 'ISO',

                // Language selection
                locale: {{ locale|tojson }},

                // Remember where the user left the calendar
                defaultView: (localStorage.getItem("fcDefaultView") !== null ? localStorage.getItem("fcDefaultView") : 'dayGridMonth'),
                defaultDate: (localStorage.getItem("fcDefaultDate") !== null ? parseInt(localStorage.getItem("fcDefaultDate")) : Date.now()),
                datesRender: function (arg) {
                    localStorage.setItem("fcDefaultView", arg.view.type);
                    localStorage.setItem("fcDefaultDate", arg.view.currentStart.getTime());
                },

                // Function called when we need to refresh the events
                // Fetches the events in eventsArray and forbiddenTimeSlots
                events: function (fetchInfo, successCallback, failureCallback) {
                    if (!compIsRequested) {
                        let courses = {{ codes|tojson }};
                        let gradient = {{ gradient|tojson }};
                        for (let i = 0, j = 0; i < courses.length; i++, j++) {
                            if (j === gradient.length)
                                j = 0;
                            eventsArray.map(function (obj) {
                                if (obj.code === courses[i]) {
                                    obj.backgroundColor = gradient[j];
                                    obj.borderColor = gradient[j];
                                }
                            })
                        }
                    } else {
                        compIsRequested = false;
                    }
                    successCallback(eventsArray.concat(forbiddenTimeSlots));
                },
                eventTextColor: 'white',

                // Extra info when hovering an event
                eventRender: function (arg) {
                    $(arg.el).tooltip({
                        title: arg.event.extendedProps.description,
                        container: 'body',
                    });
                },

                // Fix for the tooltip "bug" when dragging/resizing
                eventPositioned: function (arg) {
                    if (arg.isMirror) {
                        $(arg.el).tooltip('dispose');
                    }
                },

                // Function called when the user drops a "forbiddenTimeSlot" event
                drop: function(arg) {
                    let modal = $('#time-prompt');

                    function timePromptConfirm(e) {
                        try {
                            let startTime = $('#start_time').val().substring(0, 5);
                            let endTime = $('#end_time').val().substring(0, 5);
                            modal.modal('hide');

                            let dateStart = new Date(arg.date.getFullYear(), arg.date.getMonth(), arg.date.getDate());
                            dateStart.setHours(parseInt(startTime.split(':')[0]));
                            dateStart.setMinutes(parseInt(startTime.split(':')[1]));
                            let dateEnd = new Date(arg.date.getFullYear(), arg.date.getMonth(), arg.date.getDate());
                            dateEnd.setHours(parseInt(endTime.split(':')[0]));
                            dateEnd.setMinutes(parseInt(endTime.split(':')[1]));

                            let text = arg.draggedEl.textContent;
                            let color = window.getComputedStyle(arg.draggedEl, null).getPropertyValue("background-color");

                            // NEW EVENT
                            forbiddenTimeSlots.push({
                                title: text,
                                start: dateStart.toISOString(),
                                end: dateEnd.toISOString(),
                                backgroundColor: color,
                                borderColor: color,
                                editable: true,
                                description: {{ _('A time slot where the user would like to be free')|tojson }}
                            });
                            send_fts_to_serv();
                            calendar.refetchEvents();
                        } catch(err) {
                            $('#modal-wrong-format').modal('show');
                        }
                    }

                    modal.on('click', '#time-prompt-confirm', timePromptConfirm);
                    modal.on('hide.bs.modal', function(e) {modal.off('click', '#time-prompt-confirm', timePromptConfirm);});
                    modal.modal();
                },

                // Function called to create a copy of a "forbiddenTimeSlot" event (with ALT+click)
                eventDragStart: function(arg) {
                    if(arg.jsEvent.altKey) {
                        dragToCopy = true;
                        calendar.refetchEvents();
                        $('div').tooltip('dispose');
                    }
                },

                // Function called when the user tries to moves a "forbiddenTimeSlot" event
                eventDrop: function(arg) {
                    if(!dragToCopy) {
                        // First, we remove the event before the drag
                        let i;
                        for (i = 0; i < forbiddenTimeSlots.length; i++) {
                            let o = forbiddenTimeSlots[i];
                            if (o.title === arg.oldEvent.title && o.start === arg.oldEvent.start.toISOString()
                                && o.end === arg.oldEvent.end.toISOString()) {
                                forbiddenTimeSlots.splice(i, 1);
                                break;
                            }
                        }
                    } else {
                        dragToCopy = false;
                    }
                    // We then add the new event
                    forbiddenTimeSlots.push({
                        title: arg.oldEvent.title,
                        start: arg.event.start.toISOString(),
                        end: arg.event.end.toISOString(),
                        backgroundColor: arg.oldEvent.backgroundColor,
                        borderColor: arg.oldEvent.borderColor,
                        editable: true,
                        description: {{ _('A time slot where the user would like to be free')|tojson }}
                    });
                    send_fts_to_serv();
                },

                // Function called when the user tries to resize a "forbiddenTimeSlot" event
                eventResize: function(arg) {
                    // First, we remove the event before the drag
                    let i;
                    for (i = 0; i < forbiddenTimeSlots.length; i++) {
                        let o = forbiddenTimeSlots[i];
                        if(o.title === arg.prevEvent.title && o.start === arg.prevEvent.start.toISOString()
                            && o.end === arg.prevEvent.end.toISOString()) {
                            forbiddenTimeSlots.splice(i,1);
                            break;
                        }
                    }
                    // We then add the new event
                    forbiddenTimeSlots.push({
                        title: arg.prevEvent.title,
                        start: arg.event.start.toISOString(),
                        end: arg.event.end.toISOString(),
                        backgroundColor: arg.prevEvent.backgroundColor,
                        borderColor: arg.prevEvent.borderColor,
                        editable: true,
                        description: {{ _('A time slot where the user would like to be free')|tojson }}
                    });
                    send_fts_to_serv();
                },

                // Delete a "forbiddenTimeSlot" event with SHIFT+click
                // Classical course events cannot be deleted !
                eventClick: function(arg) {
                    if(arg.jsEvent.shiftKey) {
                        let i;
                        for (i = 0; i < forbiddenTimeSlots.length; i++) {
                            let o = forbiddenTimeSlots[i];
                            if (o.title === arg.event.title && o.start === arg.event.start.toISOString()
                                && o.end === arg.event.end.toISOString()) {
                                forbiddenTimeSlots.splice(i, 1);
                                $(arg.el).tooltip('dispose');
                                arg.event.remove();
                                send_fts_to_serv();
                                break;
                            }
                        }
                    }
                }
            });

            // Display requested schedule
            $('a[data-toggle="tab"]').on('show.bs.tab', function(e) {
                switch ($(e.target).attr('id')) {
                    case 'nav-brut':
                        eventsArray = {{ data_base|safe }};
                    break;
                    case 'nav-sched-1':
                        eventsArray = JSON.parse(schedules.sched_1);
                    break;
                    case 'nav-sched-2':
                        eventsArray = JSON.parse(schedules.sched_2);
                    break;
                    case 'nav-sched-3':
                        eventsArray = JSON.parse(schedules.sched_3);
                    break;
                }
                calendar.refetchEvents();
            });

            // Display course comparaison
            $('#btn-sched-compare').on('click', function(event) {
                if (!$('#check-sched-default').is(':checked') &&
                    !$('#check-sched-1').is(':checked') &&
                    !$('#check-sched-2').is(':checked') &&
                    !$('#check-sched-3').is(':checked')) {
                    $('#modal-no-comp').modal('show');
                } else {
                    compIsRequested = true;
                    eventsArray = [];
                    if ($('#check-sched-default').is(':checked')) {
                        eventsArray = {{ data_base|safe }};
                    }
                    if ($('#check-sched-1').is(':checked')) {
                        evtList = JSON.parse(schedules.sched_1);
                        for (let j = 0; j < evtList.length; j++) {
                            let evt = evtList[j];
                            evt.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--sched-1-color');
                            evt.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--sched-1-color');
                            eventsArray.push(evt);
                        }
                    }
                    if ($('#check-sched-2').is(':checked')) {
                        evtList = JSON.parse(schedules.sched_2);
                        for (let j = 0; j < evtList.length; j++) {
                            let evt = evtList[j];
                            evt.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--sched-2-color');
                            evt.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--sched-2-color');
                            eventsArray.push(evt);
                        }
                    }
                    if ($('#check-sched-3').is(':checked')) {
                        evtList = JSON.parse(schedules.sched_3);
                        for (let j = 0; j < evtList.length; j++) {
                            let evt = evtList[j];
                            evt.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--sched-3-color');
                            evt.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--sched-3-color');
                            eventsArray.push(evt);
                        }
                    }
                }
                calendar.refetchEvents();
            });

            calendar.render();
        });
    </script>

    <script>
        // Time picker for FTS
        $('.clockpicker').clockpicker({
            autoclose: true,
        });
    </script>
{% endblock %}
